.PHONY: usage tests license man

.DEFAULT: usage

export GO111MODULE=on

PACKAGE=citop
LICENSES_THIRD_PARTY=LICENSES_THIRD_PARTY

VERSION=$(shell git describe --tags --long --dirty)
DATE=$(shell date +"%B %d, %+4Y")

usage:
	@echo "Usage:"
	@echo "    make license     # Build third-party license"
	@echo "    make build       # Build executable"
	@echo "    make man         # Build manual page"
	@echo "    make tests       # Run unit tests"

build: man
	@echo "Building citop $(VERSION)"
	go build -ldflags "-X main.Version=$(VERSION)"

man:
	MD="$$(sed '1s/<version>/$(VERSION)/;3s/<date>/$(DATE)/' man/citop_pandoc.md)" && \
	echo "$$MD" | pandoc -s -t html5 --css './style.css' > docs/man.html && \
	echo "$$MD" | pandoc -s -t man >  man/$(PACKAGE).man.1
	{ \
	    echo "// Do not edit. This file is generated by running 'make man'." ; \
	    echo "package man" ; \
	    echo ; \
	    echo "const Section1 = \`$$(sed 's/`/` + "`" + `/g' man/$(PACKAGE).man.1)\`" ; \
	} > man/man.go

tests:
	go test -v ./...

license:
	{ \
	    echo -e "Below is a copy of the license of every package used by $(PACKAGE)" ; \
	    for pkg_dir in $$(go list -f '{{.Dir}}' -m all | grep -v $(PACKAGE)); \
	    do \
		find "$$pkg_dir" \
		    -maxdepth 1 \
		    -name LICENSE \
		    -exec echo -e "\n\n====== $$(echo $$pkg_dir | sed 's/.*\/\(go\/.*\)/\1/') ======\n" \; \
		    -exec fold -s {} \; ; \
	    done \
	} > $(LICENSES_THIRD_PARTY)

